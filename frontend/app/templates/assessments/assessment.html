{% extends "master.html" %}

{% block title %}Assessment{% endblock %}

{% block head %}
{{ super() }}
{# CSS für die rote Umrandung bei Fehlern #}
<style>
  .assessment-card.is-invalid {
    border: 1px solid #dc3545;
    /* Bootstrap's danger color */
    box-shadow: 0 0 0.25rem rgba(220, 53, 69, 0.5);
  }

  .server-error-message {
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
  }
</style>
{% endblock %}

{% block content %}
<h1 class="sr-only">RAT</h1>

<div class="row">
  <div class="col-3">
    <div class="row mb-2 py-0">
      <div class="col-10">
        <div class="progress" style="height: 25px">
          <div class="progress-bar bg-secondary" role="progressbar" style="width: {{pct}}%;" aria-valuenow="{{closed}}"
            aria-valuemax="{{all}}"></div>
        </div>
      </div>
      <div class="col text-start">{{ pct }}%</div>
    </div>
    {% if task_item.study.task %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        {# We need to check the task_type because the relationship to Query has a different name #}
        {% set query_text = '' %}
        {% if task_type == 'result' and task_item.query_ %}
            {% set query_text = task_item.query_.query %}
        {% elif task_type == 'result_ai' and task_item.query %}
            {% set query_text = task_item.query.query %}
        {% elif task_type == 'result_chatbot' and task_item.query %}
            {% set query_text = task_item.query.query %}
        {% endif %}
        <p class="card-text">{{ task_item.study.task | replace('***', '<b>'~query_text~'</b>') | safe}}</p>
      </div>
    </div>
    {% endif %}

    <form method="POST" id="assessment-form" novalidate>
      {{ form.hidden_tag() }} {# CSRF Token #}

      {% for answer in answers %}
      {% set question = answer.question %}
      {% set display_type = question.questiontype.display %}
      {% set field_name = 'question_' ~ question.id %}
      {% set has_error = errors and question.id in errors %}

      <div class="card mb-4 shadow-sm assessment-card {% if has_error %}is-invalid{% endif %}"
        data-display-type="{{ display_type }}">
        <div class="card-header"><b>{{ question.title }}</b></div>
        <div class="card-body">
          {% set old_value = submitted_data.get(field_name) %}

          {% if display_type == 'short_text' %}
          <input type="text" name="{{ field_name }}" class="form-control" value="{{ old_value or '' }}">
          {% elif display_type == 'long_text' %}
          <textarea name="{{ field_name }}" class="form-control" rows="3">{{ old_value or '' }}</textarea>
          {% elif display_type in ['true_false', 'likert_scale'] %}
          {% for option in question.options|sort(attribute='position') %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="{{ field_name }}" value="{{ option.value }}" id="q{{question.id}}-opt{{option.id}}" {% if old_value==option.value %}checked{% endif %}>
            <label class="form-check-label" for="q{{question.id}}-opt{{option.id}}">{{ option.label }}</label>
          </div>
          {% endfor %}
          {% elif display_type == 'multiple_choice' %}
          {% set old_values_list = submitted_data.getlist(field_name) if submitted_data.getlist is defined else [] %}
          {% for option in question.options|sort(attribute='position') %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="{{ field_name }}" value="{{ option.value }}" {% if
              option.value in old_values_list %}checked{% endif %}>
            <label class="form-check-label">{{ option.label }}</label>
          </div>
          {% endfor %}
          
          {% elif display_type == 'scale_number' %}
            {% set slider_options = {} %}
            {% for o in question.options %}{% set _ = slider_options.update({o.label: o.value}) %}{% endfor %}

            <div class="d-flex justify-content-between small">
                <span>{{ slider_options.get('start_text', slider_options.get('start', '0')) }}</span>
                <span>{{ slider_options.get('stop_text', slider_options.get('stop', '100')) }}</span>
            </div>

            <input type="range" class="form-range" name="{{ field_name }}"
                   min="{{ slider_options.get('start', '0') }}"
                   max="{{ slider_options.get('stop', '100') }}"
                   step="{{ slider_options.get('step', '1') }}"
                   value="{{ old_value or slider_options.get('start', '0') }}">
          
          {% endif %}

          <div class="js-error-message text-danger small mt-2"></div>
          {% if has_error %}
          <div class="server-error-message">{{ errors[question.id] }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}

      <div class="mt-4">
        <button type="submit" name="submit" class="btn btn-outline-primary btn-lg">Submit All Answers</button>
        
        {% if study.skippable %}
        <button type="submit" name="skip" class="btn btn-link btn-lg ms-2" formnovalidate>Skip This URL</button>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="col-9">
  {% if task_type == 'result' %}
    {% if show_urls %}
    <div class="card mb-4 shadow-sm d-flex flex-row align-items-center gap-2" style="padding: 7px;">
      <span style="font-weight: bold;">URL:</span>
      <span><a href="{{ task_item.normalized_url }}" target="_blank" class="hover-underline">{{ task_item.normalized_url }}</a></span>
    </div>
    {% endif %}

    {% set source = task_item.sources[0] %}
    {% if source.content_type and "pdf" in source.content_type %}
      <embed class="source-container" width="100%" src="data:application/pdf;base64,{{ source.bin.decode('ascii', 'ignore') }}" />
    {% else %}
      <embed class="source-container" src="data:image/png;base64,{{ source.bin.decode('ascii', 'ignore') }}" />
    {% endif %}
  
  {% elif task_type == 'result_ai' %}
    <div class="card shadow-sm">
      <div class="card-header">
        <b>AI Generated Answer</b>
      </div>
      <div class="card-body">
        {{ task_item.answer_html | safe }}
      </div>
    </div>

    {% if study.show_ai_sources and task_item.sources %}
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <b>Sources</b>
        </div>
        <div class="card-body">
            <ul class="list-unstyled">
                {% for source in task_item.sources %}
                    {% if source.main %}
                        <li><i class="fas fa-link fa-xs me-2 text-muted"></i>{{ source.main }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

  {% elif task_type == 'result_chatbot' %}
    <div class="card shadow-sm">
      <div class="card-header">
        <b>Chatbot Generated Answer</b>
      </div>
      <div class="card-body">
        {{ task_item.answer_html | safe }}
      </div>
    </div>

  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('assessment-form');
    if (!form) return;

    const submitButton = form.querySelector('button[name="submit"]');
    if (!submitButton) return;

    submitButton.addEventListener('click', function (event) {
      let allValid = true;
      const questionCards = form.querySelectorAll('.assessment-card');

      // 1. Reset previous errors
      questionCards.forEach(card => {
        const errorDiv = card.querySelector('.js-error-message');
        if (errorDiv) errorDiv.textContent = '';
        card.classList.remove('is-invalid');
        const serverError = card.querySelector('.server-error-message');
        if (serverError) serverError.style.display = 'none';
      });

      // 2. Validate each question
      questionCards.forEach(card => {
        const displayType = card.dataset.displayType;
        
        // --- KORREKTUR: Die auskommentierte Zeile ist nun wieder vorhanden ---
        // Die folgende Zeile wird auskommentiert, damit ALLE Fragetypen validiert werden.
        // const isOptional = ['short_text', 'long_text'].includes(displayType);

        let questionIsValid = false;

        // Validierungslogik für Textfelder
        if (displayType === 'short_text' || displayType === 'long_text') {
            const input = card.querySelector('input[type="text"], textarea');
            if (input && input.value.trim() !== '') {
                questionIsValid = true;
            }
        } 
        // Bestehende Logik für die anderen Fragetypen
        else if (displayType === 'scale_number') {
          if (card.querySelector('input[type="range"]')) {
            questionIsValid = true;
          }
        } else {
          if (card.querySelector('input:checked')) {
            questionIsValid = true;
          }
        }
        
        if (!questionIsValid) {
          allValid = false;
          const errorDiv = card.querySelector('.js-error-message');
          if (errorDiv) errorDiv.textContent = 'This field is required.';
          card.classList.add('is-invalid');
        }
      });

      // 3. Prevent submission if invalid
      if (!allValid) {
        event.preventDefault();
        const firstError = form.querySelector('.is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });
  });
</script>
{% endblock %}